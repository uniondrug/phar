<?php/** * @author wsfuyibing <websearch@163.com> * @date   2018-12-31 */namespace Uniondrug\Phar\Server\Handlers;use Swoole\Http\Request as SwooleRequest;use Swoole\Http\Response as SwooleResponse;use Uniondrug\Framework\Request as PhalconRequest;use Uniondrug\Phar\Server\XHttp;/** * HttpHandler * @package Uniondrug\Phar\Server\Handlers */class HttpHandler{    const REQID_KEY = 'X-Requested-Id';    const REQID_HTTP = 'HTTP_X_REQUESTED_ID';    /**     * 开始时内存     * @var int     */    public $memoryUsage = 0;    /**     * 结束时内存     * @var int     */    public $memoryEndUsage = 0;    /**     * HTTP结果     * @var string     */    private $content = '';    /**     * HTTP文档类型     * @var string     */    private $contentType = null;    /**     * HTTP请求ID     * @var string     */    private $requestId;    /**     * 请求URL     * @var string     */    private $requestUri;    /**     * 开始记时点     * @var double     */    private $requestBegin;    /**     * 是否为静态资源     * @var bool     */    private $requestAssets = false;    /**     * 是否为健康检查     * @var bool     */    private $requestHealth = false;    /**     * 是否为管理请求     * @var bool     */    private $requestManager = false;    /**     * 请求请求是内存     * 单位: MB     * @var float     */    private $requestMemory = 0.0;    /**     * Server对象     * @var XHttp     */    private $server;    /**     * HTTP状态码     * @var int     */    private $statusCode = 200;    /**     * @var SwooleRequest     */    private $swooleRequest;    /**     * @var SwooleResponse     */    private $swooleResponse;    /**     * 返回Cookie     * @var array     */    private $swooleResponseCookies = [];    /**     * 返回Headers     * @var array     */    private $swooleResponseHeaders = [];    /**     * 收到HTTP请求     * @param XHttp          $server     * @param SwooleRequest  $swooleRequest     * @param SwooleResponse $swooleResponse     */    public function __construct($server, $swooleRequest, $swooleResponse)    {        // 1. 初始化        $this->requestBegin = microtime(true);        $this->memoryUsage = memory_get_usage(true);        $this->requestMemory = ($this->memoryUsage / 1024) / 1024;        $this->server = $server;        $this->swooleRequest = $swooleRequest;        $this->swooleResponse = $swooleResponse;        $this->swooleResponseCookies = [];        $this->swooleResponseHeaders = [];        // 2. debug调试        if ($this->server->getLogger()->enableDebug()) {            $this->server->getLogger()->debug("开始HTTP请求 - 初始{%.01f}M内存", $this->requestMemory);            // 3. GET入参            if (isset($swooleRequest->get) && is_array($swooleRequest->get) && count($swooleRequest->get)) {                $this->server->getLogger()->debug("请求HTTP入参/QueryString: {%s}", http_build_query($swooleRequest->get));            }            // 4.            $raw = $swooleRequest->rawContent();            if ($raw !== '') {                $this->server->getLogger()->debug("请求HTTP入参/RawBody: {%s}", preg_replace([                    "/\n\s*/"                ], [                    ""                ], $raw));            } else {                $this->server->getLogger()->debug("请求HTTP入参/WWWFORM: {%s}", json_encode($swooleRequest->post, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE));            }        }    }    /**     * 析构     */    public function __destruct()    {        // 1. debug调试        if ($this->server->getLogger()->enableDebug()) {            $duration = microtime(true) - $this->requestBegin;            $this->server->getLogger()->debug("[d=%.06f]请求HTTP结果 - %s", $duration, preg_replace("/\n\s*/s", "", $this->content));            $this->server->getLogger()->debug("[d=%.06f]完成HTTP请求", $duration);        }        // 2. 释放        $this->swooleRequest = null;        $this->swooleResponse = null;    }    /**     * 结束处理     * 将内容交给Swoole, 由Swoole发请求方(nginx/browser),     * 同时返回请未完成后, 内存是否达到临界值     * @return bool     */    public function end()    {        // 1. status code        $this->swooleResponse->status($this->statusCode);        // 2. cookies        foreach ($this->swooleResponseCookies as $cookie) {            $this->swooleResponse->cookie($cookie[0], $cookie[1], (int) $cookie[2], $cookie[3], $cookie[4], $cookie[5], $cookie[6]);        }        // 3. headers        $contentTypeSended = false;        $this->swooleResponse->header(self::REQID_KEY, $this->getRequestId());        foreach ($this->swooleResponseHeaders as $key => $value) {            $contentTypeSended = $contentTypeSended ? $contentTypeSended : strtolower($key) === 'content-type';            $this->swooleResponse->header($key, $value);        }        if (!$contentTypeSended) {            if ($this->contentType === null) {                $this->swooleResponse->header("Content-Type", $this->server->getConfig()->contentType.';charset='.$this->server->getConfig()->charset);            } else {                $this->swooleResponse->header("Content-Type", $this->contentType);            }        }        $this->swooleResponse->header("Server", $this->server->getConfig()->getServerSoft());        // 5. cookies        $this->swooleResponse->end($this->content);        // 6. end        $this->memoryEndUsage = memory_get_usage(true);        return $this->memoryEndUsage >= $this->server->getConfig()->getAllowMemory();    }    /**     * Swoole Request assign to Phalocn Request     * @param PhalconRequest $phalconRequest     */    public function assignPhalcon(PhalconRequest $phalconRequest)    {        // 1. GPCSF        $_COOKIE = isset($this->swooleRequest->cookie) && is_array($this->swooleRequest->cookie) ? $this->swooleRequest->cookie : [];        $_FILES = isset($this->swooleRequest->files) && is_array($this->swooleRequest->files) ? $this->swooleRequest->files : [];        $_GET = isset($this->swooleRequest->get) && is_array($this->swooleRequest->get) ? $this->swooleRequest->get : [];        $_POST = isset($this->swooleRequest->post) && is_array($this->swooleRequest->post) ? $this->swooleRequest->post : [];        $_SERVER = [];        // 2. S/transfer        $servers = [            self::REQID_KEY => $this->requestId,            self::REQID_HTTP => $this->requestId        ];        if (isset($this->swooleRequest->server) && is_array($this->swooleRequest->server)) {            $servers += $this->swooleRequest->server;        }        if (isset($this->swooleRequest->header) && is_array($this->swooleRequest->header)) {            $servers += $this->swooleRequest->header;        }        foreach ($servers as $key => $value) {            $_SERVER[strtoupper($key)] = $value;        }        // 3. raw body        $phalconRequest->setRawBody($this->swooleRequest->rawContent());    }    /**     * 添加返回Cookie     * @param        $key     * @param        $value     * @param int    $expire     * @param string $path     * @param string $domain     * @param bool   $secure     * @param bool   $httponly     * @return $this     */    public function addResponseCookie($key, $value, $expire = 0, $path = '/', $domain = '', $secure = false, $httponly = false)    {        $this->swooleResponseCookies[] = [            0 => $key,            1 => $value,            2 => $expire,            3 => $path,            4 => $domain,            5 => $secure,            6 => $httponly        ];        return $this;    }    /**     * 读取全部返回Cookie     * @return array     */    public function getResponseCookie()    {        return $this->swooleResponseCookies;    }    /**     * 添加Header头     * @param string $key     * @param string $value     * @return $this     */    public function addResponseHeader(string $key, string $value)    {        $key = strtolower($key);        $this->swooleResponseHeaders[$key] = $value;        return $this;    }    /**     * 读取全部Headers     * @return array     */    public function getResponseHeader()    {        return $this->swooleResponseHeaders;    }    /**     * 是否为请求静态资源     * @return bool|int     */    public function isAssetsRequest()    {        return $this->requestAssets;    }    /**     * 是否为健康检查连接     * @return bool     */    public function isHealthRequest()    {        return $this->requestHealth;    }    /**     * 是否为Manager连接     * @return bool     */    public function isManagerRequest()    {        return $this->requestManager;    }    /**     * 读取连接信息     * @return array|bool     */    public function getClientInfo()    {        $info = $this->server->getClientInfo($this->swooleRequest->fd);        if (is_array($info)) {            $info['host'] = isset($this->swooleRequest->header['host']) ? $this->swooleRequest->header['host'] : '';        }        return $info;    }    /**     * 读取返回内容     * @return string     */    public function getContent()    {        return $this->content;    }    /**     * 设置返回内容     * @param string $content     * @return $this     */    public function setContent(string $content)    {        $this->content = $content;        return $this;    }    /**     * 读取内容格式     * @return string     */    public function getContentType()    {        return $this->contentType;    }    /**     * 设置内容格式     * @param string $contentType 文档类型     * @param string $charset     编码名称     * @return $this     */    public function setContentType(string $contentType, string $charset = null)    {        $this->contentType = $contentType.';charset='.($charset === null ? $this->server->getConfig()->charset : $charset);        return $this;    }    /**     * 读取请求ID     * @return string     */    public function getRequestId()    {        return $this->requestId;    }    public function setRequestId(string $requestId)    {        $this->requestId = $requestId;        return $this;    }    /**     * 读取HTTP状态码     * @return int     */    public function getStatusCode()    {        return $this->statusCode;    }    /**     * 设置HTTP状态码     * @param int $statusCode     * @return $this     */    public function setStatusCode($statusCode)    {        is_numeric($statusCode) && $statusCode > 0 && $this->statusCode = $statusCode;        return $this;    }    /**     * 读取当前请求的URI     * @return string     */    public function getUri()    {        return $this->requestUri;    }    /**     * 设置请求URL     * @param string $url     * @return $this     */    public function setUrl(string $url)    {        $this->requestUri = $url;        if (preg_match("/\.([_a-zA-Z0-9\-]+)$/", $url, $m) > 0) {            $this->requestAssets = true;            if ($m[1] === 'health') {                $this->requestHealth = true;            } else if ($m[1] === 'agent') {                $this->requestManager = true;            }        }        return $this;    }}