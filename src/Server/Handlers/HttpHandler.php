<?php/** * @author wsfuyibing <websearch@163.com> * @date   2018-12-31 */namespace Uniondrug\Phar\Server\Handlers;use Swoole\Http\Request as SwooleRequest;use Swoole\Http\Response as SwooleResponse;use Uniondrug\Framework\Request as PhalconRequest;/** * HttpHandler * @package Uniondrug\Phar\Server\Handlers */class HttpHandler{    const REQID_KEY = 'X-RequestId';    const REQID_HTTP = 'HTTP_X_REQUESTID';    private $content = '';    private $contentType = 'application/json';    /**     * HTTP请求ID     * @var string     */    private $requestId;    private $requestUri;    private $requestAssets = false;    private $memoryUsed = 0;    /**     * HTTP状态码     * @var int     */    private $statusCode = 200;    /**     * @var SwooleRequest     */    private $swooleRequest;    /**     * @var SwooleResponse     */    private $swooleResponse;    /**     * @var array     */    private $swooleResponseCookies = [];    /**     * @var array     */    private $swooleResponseHeaders = [];    /**     * 收到HTTP请求     * @param SwooleRequest  $swooleRequest     * @param SwooleResponse $swooleResponse     */    public function __construct($swooleRequest, $swooleResponse)    {        // 1. instance        $this->memoryUsed = memory_get_usage(false);        $this->swooleRequest = $swooleRequest;        $this->swooleResponse = $swooleResponse;        $this->swooleResponseCookies = [];        $this->swooleResponseHeaders = [];        // 2. request id        $requestId = isset($swooleRequest->header, $swooleRequest->header[self::REQID_HTTP]) ? $swooleRequest->header[self::REQID_HTTP] : '';        $requestId || $requestId = uniqid('req');        // 3. URL        $this->requestId = $requestId;        $this->requestUri = $this->swooleRequest->server['request_uri'];        $this->requestAssets = preg_match("/\.([_a-zA-Z0-9\-]+)$/", $this->requestUri) > 0;    }    /**     * 析构     */    public function __destruct()    {        $this->swooleRequest = null;        $this->swooleResponse = null;    }    /**     * Swoole Request assign to Phalocn Request     * @param PhalconRequest $phalconRequest     */    public function assignPhalcon(PhalconRequest $phalconRequest)    {        // 1. GPCSF        $_COOKIE = isset($this->swooleRequest->cookie) && is_array($this->swooleRequest->cookie) ? $this->swooleRequest->cookie : [];        $_FILES = isset($this->swooleRequest->files) && is_array($this->swooleRequest->files) ? $this->swooleRequest->files : [];        $_GET = isset($this->swooleRequest->get) && is_array($this->swooleRequest->get) ? $this->swooleRequest->get : [];        $_POST = isset($this->swooleRequest->post) && is_array($this->swooleRequest->post) ? $this->swooleRequest->post : [];        $_SERVER = [];        // 2. S/transfer        $servers = [];        if (isset($this->swooleRequest->server) && is_array($this->swooleRequest->server)) {            $servers += $this->swooleRequest->server;        }        if (isset($this->swooleRequest->header) && is_array($this->swooleRequest->header)) {            $servers += $this->swooleRequest->header;        }        foreach ($servers as $key => $value) {            $_SERVER[strtoupper($key)] = $value;        }        // 3. raw body        $phalconRequest->setRawBody($this->swooleRequest->rawContent());    }    /**     * 添加返回Cookie     * @param        $key     * @param        $value     * @param int    $expire     * @param string $path     * @param string $domain     * @param bool   $secure     * @param bool   $httponly     * @return $this     */    public function addResponseCookie($key, $value, $expire = 0, $path = '/', $domain = '', $secure = false, $httponly = false)    {        $this->swooleResponseCookies[] = [            0 => $key,            1 => $value,            2 => $expire,            3 => $path,            4 => $domain,            5 => $secure,            6 => $httponly        ];        return $this;    }    /**     * 读取全部返回Cookie     * @return array     */    public function getResponseCookie()    {        return $this->swooleResponseCookies;    }    /**     * 添加Header头     * @return $this     */    public function addResponseContentType()    {        $this->addResponseHeader('Content-Type', $this->contentType);        return $this;    }    /**     * 添加Header头     * @param string $key     * @param string $value     * @return $this     */    public function addResponseHeader(string $key, string $value)    {        $this->swooleResponseHeaders[$key] = $value;        return $this;    }    /**     * 读取全部Headers     * @return array     */    public function getResponseHeader()    {        return $this->swooleResponseHeaders;    }    /**     * 是否为请求静态资源     * @return bool|int     */    public function isAssetsRequest()    {        return $this->requestAssets;    }    /**     * 读取返回内容     * @return string     */    public function getContent()    {        return $this->content;    }    /**     * 设置返回内容     * @param string $content     * @return $this     */    public function setContent(string $content)    {        $this->content = $content;        return $this;    }    /**     * 读取内容格式     * @return string     */    public function getContentType()    {        return $this->contentType;    }    /**     * 设置内容格式     * @param string $contentType     * @return $this     */    public function setContentType(string $contentType)    {        $this->contentType = $contentType;        return $this;    }    /**     * 读取请求ID     * @return string     */    public function getRequestId()    {        return $this->requestId;    }    /**     * 读取HTTP状态码     * @return int     */    public function getStatusCode()    {        return $this->statusCode;    }    /**     * 设置HTTP状态码     * @param int $statusCode     * @return $this     */    public function setStatusCode($statusCode)    {        is_numeric($statusCode) && $statusCode > 0 && $this->statusCode = $statusCode;        return $this;    }    /**     * 申请内存/M字节     * @return double     */    public function getMemoryUsed()    {        return sprintf("%.01f", ($this->memoryUsed / 1024) / 1024);    }    /**     * @return string     */    public function getUri()    {        return $this->requestUri;    }}